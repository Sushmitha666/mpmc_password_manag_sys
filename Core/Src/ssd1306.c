#include "ssd1306.h"

/* Display buffer 128×64 */
static uint8_t SSD1306_Buffer[128 * 64 / 8];

/* Cursor */
static uint8_t SSD1306_X = 0;
static uint8_t SSD1306_Y = 0;

/* FULL 6×8 ASCII FONT (32–127) */
static const uint8_t Font6x8[96][6] = {
    {0x00,0x00,0x00,0x00,0x00,0x00}, // 32
    {0x00,0x00,0x5F,0x00,0x00,0x00}, // 33 !
    {0x00,0x07,0x00,0x07,0x00,0x00}, // 34 "
    {0x14,0x7F,0x14,0x7F,0x14,0x00}, // 35 #
    {0x24,0x2A,0x7F,0x2A,0x12,0x00}, // 36 $
    {0x23,0x13,0x08,0x64,0x62,0x00}, // 37 %
    {0x36,0x49,0x55,0x22,0x50,0x00}, // 38 &
    {0x00,0x05,0x03,0x00,0x00,0x00}, // 39 '
    {0x00,0x1C,0x22,0x41,0x00,0x00}, // 40 (
    {0x00,0x41,0x22,0x1C,0x00,0x00}, // 41 )
    {0x14,0x08,0x3E,0x08,0x14,0x00}, // 42 *
    {0x08,0x08,0x3E,0x08,0x08,0x00}, // 43 +
    {0x00,0x50,0x30,0x00,0x00,0x00}, // 44 ,
    {0x08,0x08,0x08,0x08,0x08,0x00}, // 45 -
    {0x00,0x60,0x60,0x00,0x00,0x00}, // 46 .
    {0x20,0x10,0x08,0x04,0x02,0x00}, // 47 /
    {0x3E,0x51,0x49,0x45,0x3E,0x00}, // 48 0
    {0x00,0x42,0x7F,0x40,0x00,0x00}, // 49 1
    {0x42,0x61,0x51,0x49,0x46,0x00}, // 50 2
    {0x21,0x41,0x45,0x4B,0x31,0x00}, // 51 3
    {0x18,0x14,0x12,0x7F,0x10,0x00}, // 52 4
    {0x27,0x45,0x45,0x45,0x39,0x00}, // 53 5
    {0x3C,0x4A,0x49,0x49,0x30,0x00}, // 54 6
    {0x01,0x71,0x09,0x05,0x03,0x00}, // 55 7
    {0x36,0x49,0x49,0x49,0x36,0x00}, // 56 8
    {0x06,0x49,0x49,0x29,0x1E,0x00}, // 57 9
    {0x00,0x36,0x36,0x00,0x00,0x00}, // :
    {0x00,0x56,0x36,0x00,0x00,0x00}, // ;
    {0x08,0x14,0x22,0x41,0x00,0x00}, // <
    {0x14,0x14,0x14,0x14,0x14,0x00}, // =
    {0x00,0x41,0x22,0x14,0x08,0x00}, // >
    {0x02,0x01,0x51,0x09,0x06,0x00}, // ?
    {0x32,0x49,0x79,0x41,0x3E,0x00}, // @
    {0x7E,0x11,0x11,0x11,0x7E,0x00}, // A
};

/* LOW-LEVEL I2C */
static void ssd1306_WriteCommand(uint8_t cmd)
{
    HAL_I2C_Mem_Write(&hi2c1, SSD1306_I2C_ADDR, 0x00, 1, &cmd, 1, 10);
}

static void ssd1306_WriteData(uint8_t *data, uint16_t size)
{
    HAL_I2C_Mem_Write(&hi2c1, SSD1306_I2C_ADDR, 0x40, 1, data, size, 100);
}

/* INIT */
void ssd1306_Init(void)
{
    HAL_Delay(100);

    ssd1306_WriteCommand(0xAE);
    ssd1306_WriteCommand(0x20);
    ssd1306_WriteCommand(0x00);
    ssd1306_WriteCommand(0xB0);
    ssd1306_WriteCommand(0xC8);
    ssd1306_WriteCommand(0x00);
    ssd1306_WriteCommand(0x10);
    ssd1306_WriteCommand(0x40);
    ssd1306_WriteCommand(0x81);
    ssd1306_WriteCommand(0x7F);
    ssd1306_WriteCommand(0xA1);
    ssd1306_WriteCommand(0xA6);
    ssd1306_WriteCommand(0xA8);
    ssd1306_WriteCommand(0x3F);   // MUST BE 0x3F for 64px panel
    ssd1306_WriteCommand(0xD3);
    ssd1306_WriteCommand(0x00);
    ssd1306_WriteCommand(0xD5);
    ssd1306_WriteCommand(0x80);
    ssd1306_WriteCommand(0xD9);
    ssd1306_WriteCommand(0x22);
    ssd1306_WriteCommand(0xDA);
    ssd1306_WriteCommand(0x12);
    ssd1306_WriteCommand(0xDB);
    ssd1306_WriteCommand(0x20);
    ssd1306_WriteCommand(0x8D);
    ssd1306_WriteCommand(0x14);
    ssd1306_WriteCommand(0xAF);

    ssd1306_Fill(0);
    ssd1306_UpdateScreen();
}

/* FILL */
void ssd1306_Fill(uint8_t color)
{
    memset(SSD1306_Buffer, color ? 0xFF : 0x00, sizeof(SSD1306_Buffer));
}

/* UPDATE */
void ssd1306_UpdateScreen(void)
{
    for (uint8_t page = 0; page < 8; page++)
    {
        ssd1306_WriteCommand(0xB0 + page);
        ssd1306_WriteCommand(0x00);
        ssd1306_WriteCommand(0x10);

        ssd1306_WriteData(&SSD1306_Buffer[page * 128], 128);
    }
}

/* CURSOR */
void ssd1306_SetCursor(uint8_t x, uint8_t y)
{
    SSD1306_X = x;
    SSD1306_Y = y;
}

/* WRITE CHAR */
void ssd1306_WriteChar(char ch)
{
    if (ch < 32 || ch > 127)
        return;

    const uint8_t *bitmap = Font6x8[ch - 32];

    uint16_t page = SSD1306_Y / 8;
    uint16_t index = page * 128 + SSD1306_X;

    for (uint8_t col = 0; col < 6; col++)
        SSD1306_Buffer[index + col] = bitmap[col];

    SSD1306_X += 6;
}

/* WRITE STRING */
void ssd1306_WriteString(char *str)
{
    while (*str)
        ssd1306_WriteChar(*str++);
}
